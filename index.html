<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏ô‡∏≠‡∏ô - Local Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body>
    <div id="app"></div>

    <script>
        // ================== Local Storage Manager (‡πÅ‡∏ó‡∏ô Firebase) ==================
        
        const LocalDB = {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    return false;
                }
            },
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            load: (key, defaultValue = null) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                    return defaultValue;
                }
            },
            
            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('Error removing from localStorage:', error);
                    return false;
                }
            },
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            clear: () => {
                try {
                    localStorage.clear();
                    return true;
                } catch (error) {
                    console.error('Error clearing localStorage:', error);
                    return false;
                }
            },
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            exists: (key) => {
                return localStorage.getItem(key) !== null;
            },
            
            // ‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (KB)
            getSize: () => {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length + key.length;
                    }
                }
                return (total / 1024).toFixed(2);
            }
        };

        // ================== App State ==================
        const app = {
            // Authentication
            isLoggedIn: false,
            currentUser: null,
            users: [
                { id: 1, username: 'admin', password: 'admin123', name: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö', role: 'admin' },
                { id: 2, username: 'teacher', password: 'teacher123', name: '‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏≠', role: 'teacher' }
            ],
            
            // UI State
            darkMode: LocalDB.load('darkMode', false),
            currentPage: 'attendance',
            sidebarOpen: false,
            loadingData: false,
            
            // System Settings
            systemSettings: LocalDB.load('systemSettings', {
                schoolName: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥',
                dormName: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏ô‡∏≠‡∏ô',
                academicYear: '2568'
            }),
            
            // Data
            students: [],
            attendance: {},
            medications: {},
            healthData: {},
            
            // Filters
            selectedDate: new Date().toISOString().split('T')[0],
            selectedDorm: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            searchTerm: '',
            
            // Forms
            loginForm: { username: '', password: '' },
            loginError: '',
            newStudent: { 
                code: '', 
                name: '', 
                nickname: '', 
                disability: '', 
                dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', 
                room: '', 
                group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' 
            },
            editingStudent: null,
            editForm: { code: '', name: '', nickname: '', disability: '', dorm: '', room: '', group: '' },
            
            // Toast
            toastMessage: '',
            toastType: 'success',
            
            // Constants
            dormitories: [
                '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡∏≤‡∏ã‡∏∞‡∏•‡∏≠‡∏á', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏ó‡∏≠‡∏á‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏®‡∏£‡∏µ‡∏ï‡∏£‡∏±‡∏á', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏•‡∏µ‡∏•‡∏≤‡∏ß‡∏î‡∏µ'
            ],
            medicationTimes: [
                '‡πÄ‡∏ä‡πâ‡∏≤ ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡πÄ‡∏ä‡πâ‡∏≤ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', 
                '‡πÄ‡∏¢‡πá‡∏ô ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô'
            ]
        };

        // ================== Utility Functions ==================

        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        const showToast = (message, type = 'success') => {
            app.toastMessage = message;
            app.toastType = type;
            render();
            setTimeout(() => {
                app.toastMessage = '';
                render();
            }, 3000);
        };

        const formatThaiDate = (dateStr) => {
            const date = new Date(dateStr + 'T00:00:00');
            return new Intl.DateTimeFormat('th-TH', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            }).format(date);
        };

        // ================== Data Management Functions (‡πÉ‡∏ä‡πâ Local Storage) ==================

        const saveStudents = () => {
            try {
                LocalDB.save('students', app.students);
                console.log('‚úÖ Students saved to localStorage');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving students:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadStudents = () => {
            try {
                app.loadingData = true;
                render();
                
                const savedStudents = LocalDB.load('students', null);
                
                if (!savedStudents || savedStudents.length === 0) {
                    console.log('üìù No students found, using sample data');
                    app.students = [
                        { id: 1, code: '1825', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏£‡∏±‡∏Å‡∏ä‡∏µ‡∏ß‡∏≤', nickname: '‡∏Ñ‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡∏£‡∏á', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', room: '‡∏´‡πâ‡∏≠‡∏á 101', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 2, code: '1888', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ô‡∏¥‡∏ï‡∏£‡∏£‡∏õ‡∏£‡∏¥‡∏ß‡∏£‡∏£‡∏ï', nickname: '‡∏Ç‡πà‡∏≤‡∏à‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', room: '‡∏´‡πâ‡∏≠‡∏á 102', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 3, code: '1891', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏•‡∏≠‡∏¢‡∏£‡∏ß‡∏±‡∏ï‡∏£', nickname: '‡∏™‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏≤', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡∏≤‡∏ã‡∏∞‡∏•‡∏≠‡∏á', room: '‡∏´‡πâ‡∏≠‡∏á 201', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 4, code: '1901', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡πÇ‡∏õ‡∏£‡∏ä‡∏¥‡∏ã‡∏≤', nickname: '‡∏°‡∏ß‡∏•‡πÇ‡∏ö‡∏ß‡πå', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡∏≤‡∏ã‡∏∞‡∏•‡∏≠‡∏á', room: '‡∏´‡πâ‡∏≠‡∏á 202', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 5, code: '1835', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ô‡∏≠‡∏°‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏ô‡πå', nickname: '‡∏™‡∏°‡∏ä‡∏≤‡∏ç‡πÉ‡∏´‡∏ç‡πà', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏ó‡∏≠‡∏á‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï', room: '‡∏´‡πâ‡∏≠‡∏á 301', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' }
                    ];
                    saveStudents();
                } else {
                    app.students = savedStudents;
                    console.log(`‚úÖ Loaded ${app.students.length} students from localStorage`);
                }
            } catch (error) {
                console.error('‚ùå Error loading students:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ', 'error');
            } finally {
                app.loadingData = false;
                render();
            }
        };

        const saveAttendance = () => {
            try {
                LocalDB.save(`attendance_${app.selectedDate}`, app.attendance);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving attendance:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadAttendance = () => {
            try {
                app.attendance = LocalDB.load(`attendance_${app.selectedDate}`, {});
                console.log(`‚úÖ Loaded attendance for ${app.selectedDate}`);
                render();
            } catch (error) {
                console.error('‚ùå Error loading attendance:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
            }
        };

        const saveMedications = () => {
            try {
                LocalDB.save(`medications_${app.selectedDate}`, app.medications);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving medications:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadMedications = () => {
            try {
                app.medications = LocalDB.load(`medications_${app.selectedDate}`, {});
                console.log(`‚úÖ Loaded medications for ${app.selectedDate}`);
                render();
            } catch (error) {
                console.error('‚ùå Error loading medications:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        };

        const saveHealthData = () => {
            try {
                LocalDB.save(`healthData_${app.selectedDate}`, app.healthData);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving health data:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadHealthData = () => {
            try {
                app.healthData = LocalDB.load(`healthData_${app.selectedDate}`, {});
                console.log(`‚úÖ Loaded health data for ${app.selectedDate}`);
                render();
            } catch (error) {
                console.error('‚ùå Error loading health data:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
            }
        };

        const saveSystemSettings = () => {
            try {
                LocalDB.save('systemSettings', app.systemSettings);
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving settings:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadAllData = () => {
            console.log('üîÑ Loading all data from localStorage...');
            loadStudents();
            loadAttendance();
            loadMedications();
            loadHealthData();
            console.log('‚úÖ All data loaded');
            console.log(`üìä localStorage size: ${LocalDB.getSize()} KB`);
        };

        // ================== Backup & Restore Functions ==================

        window.backupAllData = () => {
            try {
                const backup = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    data: {
                        students: app.students,
                        systemSettings: app.systemSettings,
                        allAttendance: {},
                        allMedications: {},
                        allHealthData: {}
                    }
                };

                // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                for (let key in localStorage) {
                    if (key.startsWith('attendance_')) {
                        backup.data.allAttendance[key] = LocalDB.load(key);
                    } else if (key.startsWith('medications_')) {
                        backup.data.allMedications[key] = LocalDB.load(key);
                    } else if (key.startsWith('healthData_')) {
                        backup.data.allHealthData[key] = LocalDB.load(key);
                    }
                }

                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('‚úì ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('Error backing up data:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        };

        window.restoreFromBackup = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (!backup.version || !backup.data) {
                            throw new Error('Invalid backup file');
                        }

                        if (confirm('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                            // ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            app.students = backup.data.students || [];
                            app.systemSettings = backup.data.systemSettings || app.systemSettings;
                            
                            saveStudents();
                            saveSystemSettings();

                            // ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                            for (let key in backup.data.allAttendance) {
                                LocalDB.save(key, backup.data.allAttendance[key]);
                            }

                            // ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤
                            for (let key in backup.data.allMedications) {
                                LocalDB.save(key, backup.data.allMedications[key]);
                            }

                            // ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                            for (let key in backup.data.allHealthData) {
                                LocalDB.save(key, backup.data.allHealthData[key]);
                            }

                            loadAllData();
                            showToast(`‚úì ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${backup.timestamp})`);
                        }
                    } catch (error) {
                        console.error('Error restoring backup:', error);
                        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        window.clearAllData = () => {
            if (confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
                if (confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    LocalDB.clear();
                    app.students = [];
                    app.attendance = {};
                    app.medications = {};
                    app.healthData = {};
                    showToast('‚úì ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                    render();
                }
            }
        };

        // ================== Student Management Functions ==================

        window.addStudent = () => {
            console.log('üîµ Add student called');
            
            if (!app.newStudent.code || !app.newStudent.name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                return;
            }
            
            if (app.students.some(s => s.code === app.newStudent.code)) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            const newId = app.students.length > 0 ? Math.max(...app.students.map(s => s.id)) + 1 : 1;
            const student = { ...app.newStudent, id: newId };
            app.students.push(student);
            
            const success = saveStudents();
            
            if (success) {
                app.newStudent = { 
                    code: '', 
                    name: '', 
                    nickname: '', 
                    disability: '', 
                    dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', 
                    room: '', 
                    group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' 
                };
                showToast(`‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏° ${student.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
            render();
        };

        window.editStudent = (id) => {
            console.log('üîµ Edit student:', id);
            const student = app.students.find(s => s.id === id);
            if (student) {
                app.editingStudent = id;
                app.editForm = { ...student };
                render();
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
            }
        };

        window.saveEditStudent = () => {
            console.log('üîµ Save edit student');
            
            if (!app.editForm.code || !app.editForm.name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                return;
            }
            
            if (app.students.some(s => s.code === app.editForm.code && s.id !== app.editingStudent)) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            const index = app.students.findIndex(s => s.id === app.editingStudent);
            if (index !== -1) {
                app.students[index] = { ...app.editForm };
                const success = saveStudents();
                
                if (success) {
                    app.editingStudent = null;
                    showToast('‚úì ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                render();
            }
        };

        window.cancelEdit = () => {
            app.editingStudent = null;
            render();
        };

        window.deleteStudent = (id) => {
            const student = app.students.find(s => s.id === id);
            if (!student) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                return;
            }
            
            if (confirm(`‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${student.name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö`)) {
                app.students = app.students.filter(s => s.id !== id);
                saveStudents();
                showToast(`‚úì ‡∏•‡∏ö ${student.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                render();
            }
        };

        // ================== Attendance Functions ==================

        window.updateAttendance = (studentId, session, field, value) => {
            if (!app.attendance[studentId]) app.attendance[studentId] = {};
            if (!app.attendance[studentId][session]) app.attendance[studentId][session] = {};
            app.attendance[studentId][session][field] = value;
            
            saveAttendance();
            render();
        };

        window.updateMedication = (studentId, med, taken) => {
            if (!app.medications[studentId]) app.medications[studentId] = {};
            app.medications[studentId][med] = { 
                taken, 
                date: app.selectedDate, 
                time: new Date().toLocaleTimeString('th-TH') 
            };
            
            saveMedications();
            render();
        };

        window.updateHealth = (dorm, notes) => {
            app.healthData[dorm] = {
                notes,
                timestamp: new Date().toISOString()
            };
            
            const success = saveHealthData();
            if (success) {
                showToast(`‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${dorm} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
            render();
        };

        // ================== Import/Export Functions ==================

        window.importStudentsCSV = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const rows = text.split('\n').slice(1);
                        
                        let importCount = 0;
                        let errorCount = 0;
                        
                        for (const row of rows) {
                            if (!row.trim()) continue;
                            
                            const [code, name, nickname, dorm, room, disability, group] = row.split(',');
                            
                            if (!code || !name) {
                                errorCount++;
                                continue;
                            }
                            
                            if (app.students.some(s => s.code === code.trim())) {
                                errorCount++;
                                continue;
                            }
                            
                            const newId = app.students.length > 0 ? Math.max(...app.students.map(s => s.id)) + 1 : 1;
                            app.students.push({
                                id: newId,
                                code: code.trim(),
                                name: name.trim(),
                                nickname: nickname?.trim() || '',
                                dorm: dorm?.trim() || '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤',
                                room: room?.trim() || '',
                                disability: disability?.trim() || '',
                                group: group?.trim() || '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á'
                            });
                            importCount++;
                        }
                        
                        if (importCount > 0) {
                            saveStudents();
                            showToast(`‚úì ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${importCount} ‡∏Ñ‡∏ô${errorCount > 0 ? ` (‡∏Ç‡πâ‡∏≤‡∏° ${errorCount})` : ''}`);
                            render();
                        } else {
                            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                        }
                    } catch (error) {
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', 'error');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            };
            input.click();
        };

        window.exportToCSV = () => {
            const filtered = getFilteredStudents();
            let csv = '\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡∏´‡∏≠‡∏ô‡∏≠‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ä‡πâ‡∏≤-‡∏£‡∏±‡∏ö,‡πÄ‡∏ä‡πâ‡∏≤-‡∏™‡πà‡∏á,‡πÄ‡∏¢‡πá‡∏ô-‡∏£‡∏±‡∏ö,‡πÄ‡∏¢‡πá‡∏ô-‡∏™‡πà‡∏á\n';
            
            filtered.forEach(s => {
                const morning = app.attendance[s.id]?.morning || {};
                const evening = app.attendance[s.id]?.evening || {};
                csv += `${s.code},${s.name},${s.nickname},${s.dorm},${s.room},${app.selectedDate},`;
                csv += `${morning.received ? '‡πÉ‡∏ä‡πà' : '-'},${morning.sent ? '‡πÉ‡∏ä‡πà' : '-'},`;
                csv += `${evening.received ? '‡πÉ‡∏ä‡πà' : '-'},${evening.sent ? '‡πÉ‡∏ä‡πà' : '-'}\n`;
            });
            
            downloadCSV(csv, `attendance_${app.selectedDate}.csv`);
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        };

        window.exportAllStudents = () => {
            let csv = '\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡∏´‡∏≠‡∏ô‡∏≠‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£,‡∏Å‡∏•‡∏∏‡πà‡∏°\n';
            app.students.forEach(s => {
                csv += `${s.code},${s.name},${s.nickname},${s.dorm},${s.room},${s.disability || '-'},${s.group}\n`;
            });
            
            downloadCSV(csv, `all_students_${new Date().toISOString().split('T')[0]}.csv`);
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        };

        const downloadCSV = (csvContent, filename) => {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        window.printReport = () => {
            const filtered = getFilteredStudents();
            const dailyStats = getDailyStats();
            
            let printContent = `
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</title>
                    <meta charset="UTF-8">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
                        body { font-family: 'Sarabun', sans-serif; margin: 20px; }
                        h1, h2 { text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        th { background-color: #f0f0f0; }
                        .summary { margin: 20px 0; padding: 15px; background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>${app.systemSettings.dormName}</h1>
                    <h2>${app.systemSettings.schoolName}</h2>
                    <p style="text-align:center">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(app.selectedDate)}</p>
                    
                    <div class="summary">
                        <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                        <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${dailyStats.total} ‡∏Ñ‡∏ô</p>
                        <p>‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏£‡∏±‡∏ö: ${dailyStats.morningReceived} ‡∏Ñ‡∏ô (${Math.round(dailyStats.morningReceived/dailyStats.total*100)}%)</p>
                        <p>‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏™‡πà‡∏á: ${dailyStats.morningSent} ‡∏Ñ‡∏ô (${Math.round(dailyStats.morningSent/dailyStats.total*100)}%)</p>
                        <p>‡πÄ‡∏¢‡πá‡∏ô - ‡∏£‡∏±‡∏ö: ${dailyStats.eveningReceived} ‡∏Ñ‡∏ô (${Math.round(dailyStats.eveningReceived/dailyStats.total*100)}%)</p>
                        <p>‡πÄ‡∏¢‡πá‡∏ô - ‡∏™‡πà‡∏á: ${dailyStats.eveningSent} ‡∏Ñ‡∏ô (${Math.round(dailyStats.eveningSent/dailyStats.total*100)}%)</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</th>
                                <th colspan="2">‡πÄ‡∏ä‡πâ‡∏≤</th><th colspan="2">‡πÄ‡∏¢‡πá‡∏ô</th>
                            </tr>
                            <tr>
                                <th></th><th></th><th></th><th></th>
                                <th>‡∏£‡∏±‡∏ö</th><th>‡∏™‡πà‡∏á</th><th>‡∏£‡∏±‡∏ö</th><th>‡∏™‡πà‡∏á</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filtered.forEach((s, index) => {
                const morning = app.attendance[s.id]?.morning || {};
                const evening = app.attendance[s.id]?.evening || {};
                printContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.code}</td>
                        <td style="text-align:left">${s.name}</td>
                        <td style="text-align:left">${s.dorm}</td>
                        <td>${morning.received ? '‚úì' : '-'}</td>
                        <td>${morning.sent ? '‚úì' : '-'}</td>
                        <td>${evening.received ? '‚úì' : '-'}</td>
                        <td>${evening.sent ? '‚úì' : '-'}</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                    </table>
                    <div style="margin-top: 50px;">
                        <p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ .................................. ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                        <p style="margin-left: 50px">(${app.currentUser.name})</p>
                        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(app.selectedDate)}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 250);
        };

        // ================== Statistics Functions ==================

        const getFilteredStudents = () => {
            return app.students.filter(student => {
                const matchesDorm = app.selectedDorm === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || student.dorm === app.selectedDorm;
                const searchLower = app.searchTerm.toLowerCase();
                const matchesSearch = student.name.toLowerCase().includes(searchLower) ||
                                     student.nickname.toLowerCase().includes(searchLower) ||
                                     student.code.includes(app.searchTerm);
                return matchesDorm && matchesSearch;
            });
        };

        const getDailyStats = () => {
            const stats = {
                morningReceived: 0,
                morningSent: 0,
                eveningReceived: 0,
                eveningSent: 0,
                total: app.students.length
            };
            
            app.students.forEach(student => {
                const morning = app.attendance[student.id]?.morning || {};
                const evening = app.attendance[student.id]?.evening || {};
                
                if (morning.received) stats.morningReceived++;
                if (morning.sent) stats.morningSent++;
                if (evening.received) stats.eveningReceived++;
                if (evening.sent) stats.eveningSent++;
            });
            
            return stats;
        };

        // ================== Authentication Functions ==================

        const handleLogin = () => {
            if (!app.loginForm.username || !app.loginForm.password) {
                app.loginError = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                render();
                return;
            }
            
            const user = app.users.find(u => 
                u.username === app.loginForm.username && 
                u.password === app.loginForm.password
            );
            
            if (user) {
                app.isLoggedIn = true;
                app.currentUser = user;
                app.loginError = '';
                app.loginForm = { username: '', password: '' };
                loadAllData();
                showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${user.name}`);
            } else {
                app.loginError = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                render();
            }
        };

        const handleLogout = () => {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                app.isLoggedIn = false;
                app.currentUser = null;
                app.currentPage = 'attendance';
                showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        };

        // ================== Render Functions (‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô - ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ) ==================

        const renderStudentManagementPage = () => {
            const isDark = app.darkMode;
            const filteredStudents = app.students.filter(student => {
                const matchesSearch = student.name.toLowerCase().includes(app.searchTerm.toLowerCase()) ||
                                     student.nickname.toLowerCase().includes(app.searchTerm.toLowerCase()) ||
                                     student.code.includes(app.searchTerm);
                return matchesSearch;
            });
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center flex-wrap gap-4">
                        <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="window.backupAllData();" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2 shadow-md">
                                üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="window.restoreFromBackup();" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center gap-2 shadow-md">
                                üìÇ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="window.importStudentsCSV();" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-md">
                                üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                            </button>
                            <button onclick="window.exportAllStudents();" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 shadow-md">
                                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                            </button>
                        </div>
                    </div>

                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
                    <div class="${isDark ? 'bg-gray-800' : 'bg-blue-50'} rounded-lg p-4 border-l-4 border-blue-500">
                        <p class="${isDark ? 'text-gray-300' : 'text-gray-700'} text-sm">
                            üíæ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: <strong>${LocalDB.getSize()} KB</strong> / ~5,000 KB
                            <span class="text-xs ml-2">(‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.round((LocalDB.getSize() / 5000) * 100)}% ‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)</span>
                        </p>
                        <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} text-xs mt-1">
                            üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥
                        </p>
                    </div>
                    
                    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6 border-t-4 border-green-500">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                                <input type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1825" value="${escapeHtml(app.newStudent.code)}" oninput="app.newStudent.code = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                                <input type="text" placeholder="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á..." value="${escapeHtml(app.newStudent.name)}" oninput="app.newStudent.name = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" value="${escapeHtml(app.newStudent.nickname)}" oninput="app.newStudent.nickname = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
                            </div>
                        </div>
                        <button onclick="window.addStudent();" class="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium shadow-md">
                            ‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                    </div>

                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold">
                                üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span class="${isDark ? 'bg-blue-600' : 'bg-blue-100 text-blue-800'} px-3 py-1 rounded-full text-sm">${app.students.length} ‡∏Ñ‡∏ô</span>
                            </h3>
                            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${escapeHtml(app.searchTerm)}" oninput="app.searchTerm = this.value; render();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} px-4 py-2 border rounded-lg w-64" />
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="${isDark ? 'bg-gray-700' : 'bg-blue-100'}">
                                        <th class="px-4 py-3 text-left">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                        <th class="px-4 py-3 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                                        <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                                        <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody class="${isDark ? 'divide-gray-700' : 'divide-gray-200'} divide-y">
                                    ${filteredStudents.length === 0 ? `
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                ${app.searchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'}
                                            </td>
                                        </tr>
                                    ` : filteredStudents.map((s, index) => `
                                        <tr class="${isDark ? 'hover:bg-gray-700' : 'hover:bg-blue-50'}">
                                            <td class="px-4 py-3 text-center">${index + 1}</td>
                                            <td class="px-4 py-3 font-mono">${escapeHtml(s.code)}</td>
                                            <td class="px-4 py-3">${escapeHtml(s.name)}</td>
                                            <td class="px-4 py-3">${escapeHtml(s.nickname)}</td>
                                            <td class="px-4 py-3 text-center">
                                                <button onclick="window.editStudent(${s.id});" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs mr-2">
                                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                                </button>
                                                <button onclick="window.deleteStudent(${s.id});" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">
                                                    üóëÔ∏è ‡∏•‡∏ö
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${app.editingStudent ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target === this) window.cancelEdit();">
                            <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-2xl p-6 w-full max-w-2xl" onclick="event.stopPropagation();">
                                <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4 text-xl">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                                        <input type="text" value="${escapeHtml(app.editForm.code)}" oninput="app.editForm.code = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg" />
                                    </div>
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                                        <input type="text" value="${escapeHtml(app.editForm.name)}" oninput="app.editForm.name = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg" />
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button onclick="window.saveEditStudent();" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                    </button>
                                    <button onclick="window.cancelEdit();" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                        ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ render functions ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ...

        const render = () => {
            const isDark = app.darkMode;
            LocalDB.save('darkMode', isDark);
            
            const root = document.getElementById('app');
            
            if (!app.isLoggedIn) {
                root.innerHTML = `
                    <div class="${isDark ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-600 to-blue-800'} min-h-screen flex items-center justify-center p-4">
                        <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full flex items-center justify-center text-white text-4xl mx-auto mb-4">
                                    üè†
                                </div>
                                <h1 class="${isDark ? 'text-white' : 'text-gray-800'} text-3xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</h1>
                                <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-2">${app.systemSettings.schoolName}</p>
                                <p class="${isDark ? 'text-blue-400' : 'text-blue-600'} text-xs mt-2">üíæ Local Storage Edition</p>
                            </div>
                            <div class="space-y-4">
                                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" value="${app.loginForm.username}" oninput="app.loginForm.username = this.value;" onkeypress="if(event.key==='Enter') handleLogin();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-3 border rounded-lg" />
                                <input type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" value="${app.loginForm.password}" oninput="app.loginForm.password = this.value;" onkeypress="if(event.key==='Enter') handleLogin();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-3 border rounded-lg" />
                                ${app.loginError ? `<div class="p-3 ${isDark ? 'bg-red-900 text-red-300' : 'bg-red-100 text-red-700'} rounded-lg text-sm">${app.loginError}</div>` : ''}
                                <button onclick="handleLogin();" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 font-bold">
                                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                                </button>
                            </div>
                            <div class="${isDark ? 'bg-gray-700 text-gray-300' : 'bg-blue-50 text-gray-700'} mt-6 p-4 rounded-lg text-sm">
                                <p class="font-bold mb-2">üîê ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</p>
                                <p>üë§ admin / admin123</p>
                                <p>üë®‚Äçüè´ teacher / teacher123</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            const pages = {
                students: renderStudentManagementPage(),
            };

            root.innerHTML = `
                <div class="flex h-screen ${isDark ? 'bg-gray-900' : 'bg-gray-100'}">
                    <div class="fixed inset-y-0 left-0 w-64 bg-gradient-to-b from-blue-600 to-blue-800 text-white p-4">
                        <h2 class="text-xl font-bold mb-6">${app.systemSettings.dormName}</h2>
                        <nav class="space-y-2">
                            <button onclick="app.currentPage = 'students'; render();" class="w-full text-left px-4 py-3 rounded-lg ${app.currentPage === 'students' ? 'bg-blue-700' : 'hover:bg-blue-700/50'}">
                                üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                        </nav>
                        <div class="absolute bottom-4 left-4 right-4">
                            <button onclick="app.darkMode = !app.darkMode; render();" class="w-full px-4 py-3 hover:bg-blue-700/50 rounded-lg mb-2">
                                ${app.darkMode ? '‚òÄÔ∏è Light' : 'üåô Dark'} Mode
                            </button>
                            <button onclick="handleLogout();" class="w-full px-4 py-3 hover:bg-blue-700/50 rounded-lg">
                                üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 ml-64 flex flex-col">
                        <div class="${isDark ? 'bg-gray-800' : 'bg-white'} shadow-md p-4">
                            <span class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">${app.currentUser?.name}</span>
                        </div>
                        <div class="${isDark ? 'bg-gray-900' : 'bg-gray-100'} flex-1 overflow-auto p-6">
                            ${pages[app.currentPage] || pages.students}
                        </div>
                    </div>

                    ${app.toastMessage ? `
                        <div class="${app.toastType === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-6 py-4 rounded-lg shadow-2xl fixed top-4 right-4 z-50 flex items-center gap-3">
                            <span class="text-2xl">${app.toastType === 'success' ? '‚úì' : '‚úï'}</span>
                            <span>${app.toastMessage}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        // Initial render
        render();
        console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - Local Storage Edition');
        console.log(`üìä ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${LocalDB.getSize()} KB`);
    </script>
</body>
</html>
