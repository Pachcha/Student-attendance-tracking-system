<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏ô‡∏≠‡∏ô - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ================== Firebase Configuration ==================
        // IMPORTANT: Configure Firebase Security Rules at Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyBrxqiawo1PCK4lrU6-gYgmOE74ujXdPmQ",
            authDomain: "student-attendance-track-53618.firebaseapp.com",
            databaseURL: "https://student-attendance-track-53618-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "student-attendance-track-53618",
            storageBucket: "student-attendance-track-53618.firebasestorage.app",
            messagingSenderId: "508348201605",
            appId: "1:508348201605:web:8614c619aa24932c0987ec"
        };

        // Initialize Firebase
        let db;
        let isOnline = navigator.onLine;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Enable offline persistence
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log('‚úÖ Offline persistence enabled');
                })
                .catch((err) => {
                    if (err.code === 'failed-precondition') {
                        console.warn('‚ö†Ô∏è Multiple tabs open, persistence enabled in first tab only');
                    } else if (err.code === 'unimplemented') {
                        console.warn('‚ö†Ô∏è Browser does not support offline persistence');
                    }
                });
            
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase');
        }

        // ================== App State ==================
        const app = {
            // Authentication
            isLoggedIn: false,
            currentUser: null,
            users: [
                { id: 1, username: 'admin', password: 'admin123', name: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö', role: 'admin' },
                { id: 2, username: 'teacher', password: 'teacher123', name: '‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏≠', role: 'teacher' }
            ],
            
            // UI State
            darkMode: false,
            currentPage: 'attendance',
            sidebarOpen: false,
            loadingData: false,
            loadingMessage: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
            
            // Pagination
            currentAttendancePage: 1,
            itemsPerPage: 50,
            
            // System Settings
            systemSettings: {
                schoolName: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥',
                dormName: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏ô‡∏≠‡∏ô',
                academicYear: '2568'
            },
            
            // Data
            students: [],
            attendance: {},
            medications: {},
            healthData: {},
            
            // Filters
            selectedDate: new Date().toISOString().split('T')[0],
            selectedDorm: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            searchTerm: '',
            
            // Forms
            loginForm: { username: '', password: '' },
            loginError: '',
            newStudent: { 
                code: '', 
                name: '', 
                nickname: '', 
                disability: '', 
                dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', 
                room: '', 
                group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' 
            },
            editingStudent: null,
            editForm: { code: '', name: '', nickname: '', disability: '', dorm: '', room: '', group: '' },
            
            // Toast
            toastMessage: '',
            toastType: 'success',
            
            // Constants
            dormitories: [
                '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡∏≤‡∏ã‡∏∞‡∏•‡∏≠‡∏á', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏ó‡∏≠‡∏á‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏®‡∏£‡∏µ‡∏ï‡∏£‡∏±‡∏á', 
                '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏•‡∏µ‡∏•‡∏≤‡∏ß‡∏î‡∏µ'
            ],
            medicationTimes: [
                '‡πÄ‡∏ä‡πâ‡∏≤ ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡πÄ‡∏ä‡πâ‡∏≤ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', 
                '‡πÄ‡∏¢‡πá‡∏ô ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 
                '‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô'
            ]
        };

        // ================== Utility Functions ==================

        const sanitizeHTML = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        const showToast = (message, type = 'success') => {
            app.toastMessage = message;
            app.toastType = type;
            render();
            setTimeout(() => {
                app.toastMessage = '';
                render();
            }, 3000);
        };

        const setLoading = (isLoading, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') => {
            app.loadingData = isLoading;
            app.loadingMessage = message;
            render();
        };

        const formatThaiDate = (dateStr) => {
            const date = new Date(dateStr + 'T00:00:00');
            return new Intl.DateTimeFormat('th-TH', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            }).format(date);
        };

        // ================== Validation Functions ==================

        const validateStudentData = (data) => {
            const errors = [];
            
            if (!data.code || data.code.trim() === '') {
                errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            } else if (data.code.length > 10) {
                errors.push('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
            } else if (!/^[0-9]+$/.test(data.code.trim())) {
                errors.push('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            }
            
            if (!data.name || data.name.trim() === '') {
                errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            } else if (data.name.length > 100) {
                errors.push('‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
            }
            
            if (data.nickname && data.nickname.length > 50) {
                errors.push('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 50 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
            }
            
            if (data.room && data.room.length > 50) {
                errors.push('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 50 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
            }
            
            if (data.disability && data.disability.length > 200) {
                errors.push('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 200 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
            }
            
            return errors;
        };

        // ================== Offline Support ==================

        window.addEventListener('online', () => {
            isOnline = true;
            showToast('‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
            syncPendingChanges();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', 'error');
        });

        const savePendingChange = (type, data) => {
            if (!isOnline) {
                const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
                pending.push({ type, data, timestamp: Date.now() });
                localStorage.setItem('pendingChanges', JSON.stringify(pending));
                showToast('üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', 'success');
            }
        };

        const syncPendingChanges = async () => {
            const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
            if (pending.length === 0) return;
            
            showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${pending.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`, 'success');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const change of pending) {
                try {
                    if (change.type === 'attendance') {
                        await saveAttendance(change.data.studentId, change.data.session, change.data.data);
                        successCount++;
                    } else if (change.type === 'medication') {
                        await saveMedication(change.data.studentId, change.data.medTime, change.data.taken);
                        successCount++;
                    } else if (change.type === 'health') {
                        await saveHealthData(change.data.dorm, change.data.notes);
                        successCount++;
                    } else if (change.type === 'students') {
                        await saveStudentsWithRetry(3);
                        successCount++;
                    }
                } catch (error) {
                    console.error('Error syncing change:', error);
                    errorCount++;
                }
            }
            
            if (errorCount === 0) {
                localStorage.removeItem('pendingChanges');
                showToast(`‚úì ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            } else {
                showToast(`‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error');
            }
        };

        // ================== Firebase Functions with Retry ==================

        const saveStudentsWithRetry = async (retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const batch = db.batch();
                    app.students.forEach(student => {
                        const ref = db.collection('students').doc(student.id.toString());
                        batch.set(ref, student);
                    });
                    await batch.commit();
                    console.log('‚úÖ Students saved to Firebase');
                    return true;
                } catch (error) {
                    console.error(`‚ùå Error saving students (attempt ${i + 1}/${retries}):`, error);
                    if (i === retries - 1) {
                        if (!isOnline) {
                            savePendingChange('students', { students: app.students });
                            return true;
                        }
                        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                        return false;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
            return false;
        };

        const saveStudents = async () => {
            return await saveStudentsWithRetry(3);
        };

        const loadStudents = async () => {
            try {
                setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...');
                
                const snapshot = await db.collection('students').orderBy('code').get();
                
                if (snapshot.empty) {
                    console.log('üìù No students found, using sample data');
                    app.students = [
                        { id: 1, code: '1825', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏£‡∏±‡∏Å‡∏ä‡∏µ‡∏ß‡∏≤', nickname: '‡∏Ñ‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡∏£‡∏á', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', room: '‡∏´‡πâ‡∏≠‡∏á 101', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 2, code: '1888', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ô‡∏¥‡∏ï‡∏£‡∏£‡∏õ‡∏£‡∏¥‡∏ß‡∏£‡∏£‡∏ï', nickname: '‡∏Ç‡πà‡∏≤‡∏à‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', room: '‡∏´‡πâ‡∏≠‡∏á 102', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 3, code: '1891', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏•‡∏≠‡∏¢‡∏£‡∏ß‡∏±‡∏ï‡∏£', nickname: '‡∏™‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏≤', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡∏≤‡∏ã‡∏∞‡∏•‡∏≠‡∏á', room: '‡∏´‡πâ‡∏≠‡∏á 201', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 4, code: '1901', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡πÇ‡∏õ‡∏£‡∏ä‡∏¥‡∏ã‡∏≤', nickname: '‡∏°‡∏ß‡∏•‡πÇ‡∏ö‡∏ß‡πå', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡∏≤‡∏ã‡∏∞‡∏•‡∏≠‡∏á', room: '‡∏´‡πâ‡∏≠‡∏á 202', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' },
                        { id: 5, code: '1835', name: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ô‡∏≠‡∏°‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏ô‡πå', nickname: '‡∏™‡∏°‡∏ä‡∏≤‡∏ç‡πÉ‡∏´‡∏ç‡πà', disability: '', dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏ó‡∏≠‡∏á‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï', room: '‡∏´‡πâ‡∏≠‡∏á 301', group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' }
                    ];
                    await saveStudents();
                } else {
                    app.students = [];
                    snapshot.forEach(doc => {
                        app.students.push(doc.data());
                    });
                    console.log(`‚úÖ Loaded ${app.students.length} students`);
                }
            } catch (error) {
                console.error('‚ùå Error loading students:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ', 'error');
                
                // Try to load from localStorage as fallback
                const cachedStudents = localStorage.getItem('cachedStudents');
                if (cachedStudents) {
                    app.students = JSON.parse(cachedStudents);
                    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å cache', 'success');
                }
            } finally {
                // Cache students data
                localStorage.setItem('cachedStudents', JSON.stringify(app.students));
                setLoading(false);
            }
        };

        const saveAttendance = async (studentId, session, data) => {
            try {
                const docId = `${studentId}_${app.selectedDate}_${session}`;
                await db.collection('attendance').doc(docId).set({
                    studentId,
                    session,
                    date: app.selectedDate,
                    ...data,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`‚úÖ Attendance saved: ${docId}`);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving attendance:', error);
                if (!isOnline) {
                    savePendingChange('attendance', { studentId, session, data });
                    return true;
                }
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadAttendance = async () => {
            try {
                setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠...');
                
                const snapshot = await db.collection('attendance')
                    .where('date', '==', app.selectedDate)
                    .get();
                
                app.attendance = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!app.attendance[data.studentId]) {
                        app.attendance[data.studentId] = {};
                    }
                    app.attendance[data.studentId][data.session] = {
                        received: data.received || false,
                        sent: data.sent || false,
                        date: data.date,
                        timestamp: data.timestamp
                    };
                });
                console.log(`‚úÖ Loaded attendance for ${app.selectedDate}`);
            } catch (error) {
                console.error('‚ùå Error loading attendance:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
            } finally {
                setLoading(false);
            }
        };

        const saveMedication = async (studentId, medTime, taken) => {
            try {
                const docId = `${studentId}_${app.selectedDate}_${medTime}`;
                await db.collection('medications').doc(docId).set({
                    studentId,
                    medTime,
                    taken,
                    date: app.selectedDate,
                    time: new Date().toLocaleTimeString('th-TH'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`‚úÖ Medication saved: ${docId}`);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving medication:', error);
                if (!isOnline) {
                    savePendingChange('medication', { studentId, medTime, taken });
                    return true;
                }
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadMedications = async () => {
            try {
                setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤...');
                
                const snapshot = await db.collection('medications')
                    .where('date', '==', app.selectedDate)
                    .get();
                
                app.medications = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!app.medications[data.studentId]) {
                        app.medications[data.studentId] = {};
                    }
                    app.medications[data.studentId][data.medTime] = {
                        taken: data.taken,
                        date: data.date,
                        time: data.time
                    };
                });
                console.log(`‚úÖ Loaded medications for ${app.selectedDate}`);
            } catch (error) {
                console.error('‚ùå Error loading medications:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÑ‡∏î‡πâ', 'error');
            } finally {
                setLoading(false);
            }
        };

        const saveHealthData = async (dorm, notes) => {
            try {
                const docId = `${dorm}_${app.selectedDate}`;
                await db.collection('healthData').doc(docId).set({
                    dorm,
                    notes,
                    date: app.selectedDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`‚úÖ Health data saved: ${docId}`);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving health data:', error);
                if (!isOnline) {
                    savePendingChange('health', { dorm, notes });
                    return true;
                }
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadHealthData = async () => {
            try {
                setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û...');
                
                const snapshot = await db.collection('healthData')
                    .where('date', '==', app.selectedDate)
                    .get();
                
                app.healthData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    app.healthData[data.dorm] = {
                        notes: data.notes,
                        timestamp: data.timestamp?.toDate().toISOString()
                    };
                });
                console.log(`‚úÖ Loaded health data for ${app.selectedDate}`);
            } catch (error) {
                console.error('‚ùå Error loading health data:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
            } finally {
                setLoading(false);
            }
        };

        const saveSystemSettings = async () => {
            try {
                await db.collection('settings').doc('system').set(app.systemSettings);
                console.log('‚úÖ System settings saved');
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving settings:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        };

        const loadSystemSettings = async () => {
            try {
                const doc = await db.collection('settings').doc('system').get();
                if (doc.exists) {
                    app.systemSettings = { ...app.systemSettings, ...doc.data() };
                    console.log('‚úÖ System settings loaded');
                }
            } catch (error) {
                console.error('‚ùå Error loading settings:', error);
            }
        };

        // ================== Authentication Functions ==================

        const handleLogin = () => {
            if (!app.loginForm.username || !app.loginForm.password) {
                app.loginError = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                render();
                return;
            }
            
            const user = app.users.find(u => 
                u.username === app.loginForm.username && 
                u.password === app.loginForm.password
            );
            
            if (user) {
                app.isLoggedIn = true;
                app.currentUser = user;
                app.loginError = '';
                app.loginForm = { username: '', password: '' };
                
                // Save session
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                
                loadAllData();
                showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${user.name}`);
            } else {
                app.loginError = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                render();
            }
        };

        const handleLogout = () => {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                app.isLoggedIn = false;
                app.currentUser = null;
                app.currentPage = 'attendance';
                sessionStorage.removeItem('currentUser');
                showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        };

        // Check for existing session
        const checkSession = () => {
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                app.isLoggedIn = true;
                app.currentUser = user;
                loadAllData();
            }
        };

        // ================== Data Loading Functions ==================

        const loadAllData = async () => {
            console.log('üîÑ Loading all data...');
            await loadSystemSettings();
            await loadStudents();
            await loadAttendance();
            await loadMedications();
            await loadHealthData();
            console.log('‚úÖ All data loaded');
            render();
        };

        // ================== Student Management Functions ==================

        const addStudent = async () => {
            const errors = validateStudentData(app.newStudent);
            
            if (errors.length > 0) {
                showToast(errors.join('\n'), 'error');
                return;
            }
            
            const trimmedCode = app.newStudent.code.trim();
            
            if (app.students.some(s => s.code === trimmedCode)) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            const confirmMsg = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô?\n\n` +
                              `‡∏£‡∏´‡∏±‡∏™: ${trimmedCode}\n` +
                              `‡∏ä‡∏∑‡πà‡∏≠: ${app.newStudent.name}\n` +
                              `‡∏´‡∏≠‡∏ô‡∏≠‡∏ô: ${app.newStudent.dorm}`;
            
            if (!confirm(confirmMsg)) return;
            
            const newId = app.students.length > 0 ? Math.max(...app.students.map(s => s.id)) + 1 : 1;
            const student = { 
                id: newId,
                code: trimmedCode,
                name: app.newStudent.name.trim(),
                nickname: app.newStudent.nickname.trim(),
                disability: app.newStudent.disability.trim(),
                dorm: app.newStudent.dorm,
                room: app.newStudent.room.trim(),
                group: app.newStudent.group
            };
            
            app.students.push(student);
            app.students.sort((a, b) => a.code.localeCompare(b.code));
            
            const success = await saveStudents();
            
            if (success) {
                app.newStudent = { 
                    code: '', 
                    name: '', 
                    nickname: '', 
                    disability: '', 
                    dorm: '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤', 
                    room: '', 
                    group: '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á' 
                };
                showToast(`‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏° ${student.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
            render();
        };

        const editStudent = (id) => {
            const student = app.students.find(s => s.id === id);
            if (student) {
                app.editingStudent = id;
                app.editForm = { ...student };
                render();
            }
        };

        const saveEditStudent = async () => {
            const errors = validateStudentData(app.editForm);
            
            if (errors.length > 0) {
                showToast(errors.join('\n'), 'error');
                return;
            }
            
            const trimmedCode = app.editForm.code.trim();
            
            if (app.students.some(s => s.code === trimmedCode && s.id !== app.editingStudent)) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            const index = app.students.findIndex(s => s.id === app.editingStudent);
            if (index !== -1) {
                app.students[index] = { 
                    ...app.editForm,
                    code: trimmedCode,
                    name: app.editForm.name.trim(),
                    nickname: app.editForm.nickname.trim(),
                    disability: app.editForm.disability.trim(),
                    room: app.editForm.room.trim()
                };
                
                app.students.sort((a, b) => a.code.localeCompare(b.code));
                
                const success = await saveStudents();
                
                if (success) {
                    app.editingStudent = null;
                    showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                render();
            }
        };

        const cancelEdit = () => {
            app.editingStudent = null;
            render();
        };

        const deleteStudent = async (id) => {
            const student = app.students.find(s => s.id === id);
            if (!student) return;
            
            const confirmMsg = `‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n` +
                              `‡∏£‡∏´‡∏±‡∏™: ${student.code}\n` +
                              `‡∏ä‡∏∑‡πà‡∏≠: ${student.name}\n` +
                              `‡∏´‡∏≠‡∏ô‡∏≠‡∏ô: ${student.dorm}\n\n` +
                              `‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠, ‡∏¢‡∏≤) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!`;
            
            if (!confirm(confirmMsg)) return;
            
            setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            app.students = app.students.filter(s => s.id !== id);
            await saveStudents();
            
            try {
                await db.collection('students').doc(id.toString()).delete();
                
                const attendanceSnapshot = await db.collection('attendance')
                    .where('studentId', '==', id)
                    .get();
                const attendanceBatch = db.batch();
                attendanceSnapshot.forEach(doc => attendanceBatch.delete(doc.ref));
                await attendanceBatch.commit();
                
                const medsSnapshot = await db.collection('medications')
                    .where('studentId', '==', id)
                    .get();
                const medsBatch = db.batch();
                medsSnapshot.forEach(doc => medsBatch.delete(doc.ref));
                await medsBatch.commit();
                
                showToast(`‚úì ‡∏•‡∏ö ${student.name} ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (error) {
                console.error('Error deleting student data:', error);
                showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            } finally {
                setLoading(false);
            }
        };

        // ================== Import/Export Functions ==================

        const importStudentsCSV = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    showToast('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)', 'error');
                    return;
                }
                
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                    return;
                }
                
                setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const text = event.target.result;
                        const rows = text.split('\n').slice(1).filter(row => row.trim());
                        
                        if (rows.length === 0) {
                            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                            setLoading(false);
                            return;
                        }
                        
                        let importCount = 0;
                        let errorCount = 0;
                        let errors = [];
                        
                        for (const row of rows) {
                            const columns = row.split(',').map(col => col.trim());
                            const [code, name, nickname, dorm, room, disability, group] = columns;
                            
                            const studentData = {
                                code: code || '',
                                name: name || '',
                                nickname: nickname || '',
                                dorm: dorm || '‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤',
                                room: room || '',
                                disability: disability || '',
                                group: group || '‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á'
                            };
                            
                            const validationErrors = validateStudentData(studentData);
                            if (validationErrors.length > 0) {
                                errorCount++;
                                errors.push(`‡∏£‡∏´‡∏±‡∏™ ${code}: ${validationErrors[0]}`);
                                continue;
                            }
                            
                            if (app.students.some(s => s.code === code)) {
                                errorCount++;
                                errors.push(`‡∏£‡∏´‡∏±‡∏™ ${code}: ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
                                continue;
                            }
                            
                            const newId = app.students.length > 0 ? Math.max(...app.students.map(s => s.id)) + 1 : 1;
                            app.students.push({
                                id: newId,
                                ...studentData
                            });
                            importCount++;
                        }
                        
                        if (importCount > 0) {
                            app.students.sort((a, b) => a.code.localeCompare(b.code));
                            await saveStudents();
                            let message = `‚úì ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${importCount} ‡∏Ñ‡∏ô ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
                            if (errorCount > 0) {
                                message += `\n‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                                if (errors.length <= 5) {
                                    message += '\n' + errors.join('\n');
                                }
                            }
                            showToast(message);
                            render();
                        } else {
                            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ\n' + errors.slice(0, 5).join('\n'), 'error');
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå: ' + error.message, 'error');
                    } finally {
                        setLoading(false);
                    }
                };
                reader.onerror = () => {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
                    setLoading(false);
                };
                reader.readAsText(file, 'UTF-8');
            };
            input.click();
        };

        const exportToCSV = () => {
            const filtered = getFilteredStudents();
            let csv = '\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡∏´‡∏≠‡∏ô‡∏≠‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ä‡πâ‡∏≤-‡∏£‡∏±‡∏ö,‡πÄ‡∏ä‡πâ‡∏≤-‡∏™‡πà‡∏á,‡πÄ‡∏¢‡πá‡∏ô-‡∏£‡∏±‡∏ö,‡πÄ‡∏¢‡πá‡∏ô-‡∏™‡πà‡∏á\n';
            
            filtered.forEach(s => {
                const morning = app.attendance[s.id]?.morning || {};
                const evening = app.attendance[s.id]?.evening || {};
                csv += `${s.code},${s.name},${s.nickname},${s.dorm},${s.room},${app.selectedDate},`;
                csv += `${morning.received ? '‡πÉ‡∏ä‡πà' : '-'},${morning.sent ? '‡πÉ‡∏ä‡πà' : '-'},`;
                csv += `${evening.received ? '‡πÉ‡∏ä‡πà' : '-'},${evening.sent ? '‡πÉ‡∏ä‡πà' : '-'}\n`;
            });
            
            downloadCSV(csv, `attendance_${app.selectedDate}.csv`);
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        };

        const exportAllStudents = () => {
            let csv = '\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡∏´‡∏≠‡∏ô‡∏≠‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£,‡∏Å‡∏•‡∏∏‡πà‡∏°\n';
            app.students.forEach(s => {
                csv += `${s.code},${s.name},${s.nickname},${s.dorm},${s.room},${s.disability || '-'},${s.group}\n`;
            });
            
            downloadCSV(csv, `all_students_${new Date().toISOString().split('T')[0]}.csv`);
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        };

        const downloadCSV = (csvContent, filename) => {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        // ================== Attendance Functions ==================

        const updateAttendance = async (studentId, session, field, value) => {
            if (!app.attendance[studentId]) app.attendance[studentId] = {};
            if (!app.attendance[studentId][session]) app.attendance[studentId][session] = {};
            app.attendance[studentId][session][field] = value;
            
            await saveAttendance(studentId, session, app.attendance[studentId][session]);
            render();
        };

        const updateMedication = async (studentId, med, taken) => {
            if (!app.medications[studentId]) app.medications[studentId] = {};
            app.medications[studentId][med] = { 
                taken, 
                date: app.selectedDate, 
                time: new Date().toLocaleTimeString('th-TH') 
            };
            
            await saveMedication(studentId, med, taken);
            render();
        };

        const updateHealth = async (dorm, notes) => {
            app.healthData[dorm] = {
                notes,
                timestamp: new Date().toISOString()
            };
            
            const success = await saveHealthData(dorm, notes);
            if (success) {
                showToast(`‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${dorm} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
            render();
        };

        // ================== Statistics Functions ==================

        const getFilteredStudents = () => {
            return app.students.filter(student => {
                const matchesDorm = app.selectedDorm === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || student.dorm === app.selectedDorm;
                const searchLower = app.searchTerm.toLowerCase();
                const matchesSearch = student.name.toLowerCase().includes(searchLower) ||
                                     student.nickname.toLowerCase().includes(searchLower) ||
                                     student.code.includes(app.searchTerm);
                return matchesDorm && matchesSearch;
            });
        };

        const getDormStats = () => {
            const stats = {};
            app.dormitories.filter(d => d !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î').forEach(dorm => {
                const count = app.students.filter(s => s.dorm === dorm).length;
                stats[dorm] = count;
            });
            return stats;
        };

        const getDailyStats = () => {
            const stats = {
                morningReceived: 0,
                morningSent: 0,
                eveningReceived: 0,
                eveningSent: 0,
                total: app.students.length
            };
            
            app.students.forEach(student => {
                const morning = app.attendance[student.id]?.morning || {};
                const evening = app.attendance[student.id]?.evening || {};
                
                if (morning.received) stats.morningReceived++;
                if (morning.sent) stats.morningSent++;
                if (evening.received) stats.eveningReceived++;
                if (evening.sent) stats.eveningSent++;
            });
            
            return stats;
        };

        const getDailyStatsByDorm = () => {
            const stats = {};
            
            app.dormitories.filter(d => d !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î').forEach(dorm => {
                stats[dorm] = {
                    present: 0,
                    returned: 0,
                    leftInDorm: 0,
                    absent: 0,
                    total: 0
                };
            });
            
            app.students.forEach(student => {
                const morning = app.attendance[student.id]?.morning || {};
                const evening = app.attendance[student.id]?.evening || {};
                const dorm = student.dorm;
                
                if (!stats[dorm]) {
                    stats[dorm] = { present: 0, returned: 0, leftInDorm: 0, absent: 0, total: 0 };
                }
                
                stats[dorm].total++;
                
                if (morning.received) {
                    stats[dorm].present++;
                    if (evening.sent) {
                        stats[dorm].returned++;
                    } else {
                        stats[dorm].leftInDorm++;
                    }
                } else {
                    stats[dorm].absent++;
                }
            });
            
            return stats;
        };

        // ================== Print Functions ==================

        const printReport = () => {
            const filtered = getFilteredStudents();
            const dailyStats = getDailyStats();
            
            let printContent = `
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</title>
                    <meta charset="UTF-8">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
                        body { 
                            font-family: 'Sarabun', sans-serif; 
                            margin: 20px; 
                            font-size: 14px;
                        }
                        h1, h2 { text-align: center; margin: 10px 0; }
                        h1 { font-size: 24px; }
                        h2 { font-size: 18px; color: #333; }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0; 
                            page-break-inside: auto;
                        }
                        tr { page-break-inside: avoid; page-break-after: auto; }
                        th, td { 
                            border: 1px solid #000; 
                            padding: 8px; 
                            text-align: center; 
                        }
                        th { 
                            background-color: #e0e0e0; 
                            font-weight: bold;
                        }
                        .header { margin-bottom: 30px; }
                        .summary { 
                            margin: 20px 0; 
                            padding: 15px; 
                            background-color: #f9f9f9; 
                            border: 1px solid #ddd;
                            border-radius: 5px;
                        }
                        .summary h3 { margin-top: 0; }
                        .signature { 
                            margin-top: 50px; 
                            page-break-inside: avoid;
                        }
                        @media print {
                            body { margin: 15px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${app.systemSettings.dormName}</h1>
                        <h2>${app.systemSettings.schoolName}</h2>
                        <p style="text-align:center; font-weight: bold;">
                            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(app.selectedDate)}
                        </p>
                    </div>
                    
                    <div class="summary">
                        <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                        <table style="border: none;">
                            <tr style="border: none;">
                                <td style="border: none; text-align: left;">
                                    <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${dailyStats.total} ‡∏Ñ‡∏ô
                                </td>
                                <td style="border: none; text-align: left;">
                                    <strong>‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏£‡∏±‡∏ö:</strong> ${dailyStats.morningReceived} ‡∏Ñ‡∏ô 
                                    (${dailyStats.total > 0 ? Math.round(dailyStats.morningReceived/dailyStats.total*100) : 0}%)
                                </td>
                            </tr>
                            <tr style="border: none;">
                                <td style="border: none; text-align: left;">
                                    <strong>‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏™‡πà‡∏á:</strong> ${dailyStats.morningSent} ‡∏Ñ‡∏ô 
                                    (${dailyStats.total > 0 ? Math.round(dailyStats.morningSent/dailyStats.total*100) : 0}%)
                                </td>
                                <td style="border: none; text-align: left;">
                                    <strong>‡πÄ‡∏¢‡πá‡∏ô - ‡∏£‡∏±‡∏ö:</strong> ${dailyStats.eveningReceived} ‡∏Ñ‡∏ô 
                                    (${dailyStats.total > 0 ? Math.round(dailyStats.eveningReceived/dailyStats.total*100) : 0}%)
                                </td>
                            </tr>
                            <tr style="border: none;">
                                <td colspan="2" style="border: none; text-align: left;">
                                    <strong>‡πÄ‡∏¢‡πá‡∏ô - ‡∏™‡πà‡∏á:</strong> ${dailyStats.eveningSent} ‡∏Ñ‡∏ô 
                                    (${dailyStats.total > 0 ? Math.round(dailyStats.eveningSent/dailyStats.total*100) : 0}%)
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th rowspan="2">‡∏£‡∏´‡∏±‡∏™</th>
                                <th rowspan="2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th rowspan="2">‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</th>
                                <th colspan="2">‡πÄ‡∏ä‡πâ‡∏≤</th>
                                <th colspan="2">‡πÄ‡∏¢‡πá‡∏ô</th>
                            </tr>
                            <tr>
                                <th>‡∏£‡∏±‡∏ö</th>
                                <th>‡∏™‡πà‡∏á</th>
                                <th>‡∏£‡∏±‡∏ö</th>
                                <th>‡∏™‡πà‡∏á</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filtered.forEach((s, index) => {
                const morning = app.attendance[s.id]?.morning || {};
                const evening = app.attendance[s.id]?.evening || {};
                printContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.code}</td>
                        <td style="text-align:left; padding-left: 10px;">${sanitizeHTML(s.name)}</td>
                        <td style="text-align:left; padding-left: 10px;">${sanitizeHTML(s.dorm)}</td>
                        <td>${morning.received ? '‚úì' : '-'}</td>
                        <td>${morning.sent ? '‚úì' : '-'}</td>
                        <td>${evening.received ? '‚úì' : '-'}</td>
                        <td>${evening.sent ? '‚úì' : '-'}</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div class="signature">
                        <p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ .............................................. ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                        <p style="margin-left: 60px;">(${app.currentUser.name})</p>
                        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(app.selectedDate)}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        };

        // ================== Search with Debounce ==================

        let searchTimeout;
        const handleSearch = (value) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                app.searchTerm = value;
                render();
            }, 300);
        };

        // ================== Render Functions ==================

        const renderAttendancePage = () => {
            const isDark = app.darkMode;
            const filtered = getFilteredStudents();
            const dailyStats = getDailyStats();
            
            return `
                <div class="space-y-6">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h2>
                        <div class="flex gap-2">
                            <button onclick="printReport();" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2 shadow-md hover:shadow-lg transition-all">
                                üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                            </button>
                            <button onclick="exportToCSV();" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-md hover:shadow-lg transition-all">
                                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                            </button>
                        </div>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <input type="date" value="${app.selectedDate}" onchange="app.selectedDate = this.value; loadAttendance(); loadMedications(); loadHealthData();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            <select onchange="app.selectedDorm = this.value; render();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                ${app.dormitories.map(d => `<option ${app.selectedDorm === d ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                            <div class="relative">
                                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..." value="${app.searchTerm}" oninput="handleSearch(this.value);" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'} w-full px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                ${app.searchTerm ? `
                                    <button onclick="app.searchTerm = ''; render();" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 font-bold">
                                        ‚úï
                                    </button>
                                ` : ''}
                            </div>
                            <div class="${isDark ? 'bg-gray-700 text-white' : 'bg-blue-50 text-blue-800'} px-4 py-2 rounded-lg flex items-center justify-center font-bold">
                                ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${filtered.length} ‡∏Ñ‡∏ô
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div class="${isDark ? 'bg-amber-600' : 'bg-amber-100'} rounded-lg p-3">
                                <p class="${isDark ? 'text-amber-100' : 'text-amber-700'} text-xs">‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏£‡∏±‡∏ö</p>
                                <p class="${isDark ? 'text-white' : 'text-amber-900'} text-xl font-bold">${dailyStats.morningReceived}/${dailyStats.total}</p>
                                <p class="${isDark ? 'text-amber-200' : 'text-amber-600'} text-xs mt-1">${dailyStats.total > 0 ? Math.round((dailyStats.morningReceived/dailyStats.total)*100) : 0}%</p>
                            </div>
                            <div class="${isDark ? 'bg-orange-600' : 'bg-orange-100'} rounded-lg p-3">
                                <p class="${isDark ? 'text-orange-100' : 'text-orange-700'} text-xs">‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏™‡πà‡∏á</p>
                                <p class="${isDark ? 'text-white' : 'text-orange-900'} text-xl font-bold">${dailyStats.morningSent}/${dailyStats.total}</p>
                                <p class="${isDark ? 'text-orange-200' : 'text-orange-600'} text-xs mt-1">${dailyStats.total > 0 ? Math.round((dailyStats.morningSent/dailyStats.total)*100) : 0}%</p>
                            </div>
                            <div class="${isDark ? 'bg-blue-600' : 'bg-blue-100'} rounded-lg p-3">
                                <p class="${isDark ? 'text-blue-100' : 'text-blue-700'} text-xs">‡πÄ‡∏¢‡πá‡∏ô - ‡∏£‡∏±‡∏ö</p>
                                <p class="${isDark ? 'text-white' : 'text-blue-900'} text-xl font-bold">${dailyStats.eveningReceived}/${dailyStats.total}</p>
                                <p class="${isDark ? 'text-blue-200' : 'text-blue-600'} text-xs mt-1">${dailyStats.total > 0 ? Math.round((dailyStats.eveningReceived/dailyStats.total)*100) : 0}%</p>
                            </div>
                            <div class="${isDark ? 'bg-cyan-600' : 'bg-cyan-100'} rounded-lg p-3">
                                <p class="${isDark ? 'text-cyan-100' : 'text-cyan-700'} text-xs">‡πÄ‡∏¢‡πá‡∏ô - ‡∏™‡πà‡∏á</p>
                                <p class="${isDark ? 'text-white' : 'text-cyan-900'} text-xl font-bold">${dailyStats.eveningSent}/${dailyStats.total}</p>
                                <p class="${isDark ? 'text-cyan-200' : 'text-cyan-600'} text-xs mt-1">${dailyStats.total > 0 ? Math.round((dailyStats.eveningSent/dailyStats.total)*100) : 0}%</p>
                            </div>
                        </div>
                    </div>

                    ${app.loadingData ? `
                        <div class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                            <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-4">${app.loadingMessage}</p>
                        </div>
                    ` : `
                        <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="${isDark ? 'bg-gray-700' : 'bg-gradient-to-r from-blue-50 to-blue-100'} border-b-2">
                                            <th class="px-3 py-3 text-left font-semibold">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                            <th class="px-3 py-3 text-left font-semibold">‡∏£‡∏´‡∏±‡∏™</th>
                                            <th class="px-3 py-3 text-left font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                            <th class="px-3 py-3 text-left font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                                            <th colspan="2" class="px-3 py-3 text-center font-semibold bg-amber-500 text-white">‡πÄ‡∏ä‡πâ‡∏≤</th>
                                            <th colspan="2" class="px-3 py-3 text-center font-semibold bg-blue-500 text-white">‡πÄ‡∏¢‡πá‡∏ô</th>
                                        </tr>
                                        <tr class="${isDark ? 'bg-gray-700' : 'bg-gray-50'} border-b">
                                            <th colspan="4"></th>
                                            <th class="px-3 py-2 text-center text-xs bg-amber-400">‚úì ‡∏£‡∏±‡∏ö</th>
                                            <th class="px-3 py-2 text-center text-xs bg-amber-400">‚úì ‡∏™‡πà‡∏á</th>
                                            <th class="px-3 py-2 text-center text-xs bg-blue-400">‚úì ‡∏£‡∏±‡∏ö</th>
                                            <th class="px-3 py-2 text-center text-xs bg-blue-400">‚úì ‡∏™‡πà‡∏á</th>
                                        </tr>
                                    </thead>
                                    <tbody class="${isDark ? 'divide-gray-700' : 'divide-gray-200'} divide-y">
                                        ${filtered.length === 0 ? `
                                            <tr>
                                                <td colspan="8" class="px-3 py-8 text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                    ${app.searchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'}
                                                </td>
                                            </tr>
                                        ` : filtered.map((s, index) => {
                                            const morning = app.attendance[s.id]?.morning || {};
                                            const evening = app.attendance[s.id]?.evening || {};
                                            return `
                                                <tr class="${isDark ? 'hover:bg-gray-700' : 'hover:bg-blue-50'} transition-colors">
                                                    <td class="px-3 py-3 text-center">${index + 1}</td>
                                                    <td class="px-3 py-3 font-mono">${sanitizeHTML(s.code)}</td>
                                                    <td class="px-3 py-3 font-medium">${sanitizeHTML(s.name)}</td>
                                                    <td class="px-3 py-3 ${isDark ? 'text-gray-400' : 'text-gray-600'}">${sanitizeHTML(s.nickname)}</td>
                                                    <td class="px-3 py-3 text-center bg-amber-50">
                                                        <input type="checkbox" ${morning.received ? 'checked' : ''} onchange="updateAttendance(${s.id}, 'morning', 'received', this.checked);" class="w-5 h-5 cursor-pointer accent-amber-500" />
                                                    </td>
                                                    <td class="px-3 py-3 text-center bg-amber-50">
                                                        <input type="checkbox" ${morning.sent ? 'checked' : ''} onchange="updateAttendance(${s.id}, 'morning', 'sent', this.checked);" class="w-5 h-5 cursor-pointer accent-amber-500" />
                                                    </td>
                                                    <td class="px-3 py-3 text-center bg-blue-50">
                                                        <input type="checkbox" ${evening.received ? 'checked' : ''} onchange="updateAttendance(${s.id}, 'evening', 'received', this.checked);" class="w-5 h-5 cursor-pointer accent-blue-500" />
                                                    </td>
                                                    <td class="px-3 py-3 text-center bg-blue-50">
                                                        <input type="checkbox" ${evening.sent ? 'checked' : ''} onchange="updateAttendance(${s.id}, 'evening', 'sent', this.checked);" class="w-5 h-5 cursor-pointer accent-blue-500" />
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `}
                </div>
            `;
        };

        const renderMedicationPage = () => {
            const isDark = app.darkMode;
            const filtered = getFilteredStudents();
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">üíä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</h2>
                        <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} text-sm">
                            ${formatThaiDate(app.selectedDate)}
                        </p>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="date" value="${app.selectedDate}" onchange="app.selectedDate = this.value; loadMedications();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" />
                            <select onchange="app.selectedDorm = this.value; render();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                ${app.dormitories.map(d => `<option ${app.selectedDorm === d ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                            <div class="relative">
                                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${app.searchTerm}" oninput="handleSearch(this.value);" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'} w-full px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" />
                                ${app.searchTerm ? `
                                    <button onclick="app.searchTerm = ''; render();" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 font-bold">
                                        ‚úï
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    ${app.loadingData ? `
                        <div class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                            <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-4">${app.loadingMessage}</p>
                        </div>
                    ` : `
                        <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="${isDark ? 'bg-gray-700' : 'bg-purple-100'} border-b-2">
                                            <th class="px-4 py-3 text-left font-semibold sticky left-0 ${isDark ? 'bg-gray-700' : 'bg-purple-100'} z-10">‡∏£‡∏´‡∏±‡∏™</th>
                                            <th class="px-4 py-3 text-left font-semibold sticky left-20 ${isDark ? 'bg-gray-700' : 'bg-purple-100'} z-10">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                            ${app.medicationTimes.map(time => `<th class="px-4 py-3 text-center font-semibold text-sm whitespace-nowrap">${time}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody class="${isDark ? 'divide-gray-700' : 'divide-gray-200'} divide-y">
                                        ${filtered.length === 0 ? `
                                            <tr>
                                                <td colspan="${2 + app.medicationTimes.length}" class="px-4 py-8 text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                    ${app.searchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'}
                                                </td>
                                            </tr>
                                        ` : filtered.map(s => `
                                            <tr class="${isDark ? 'hover:bg-gray-700' : 'hover:bg-purple-50'} transition-colors">
                                                <td class="px-4 py-3 font-mono sticky left-0 ${isDark ? 'bg-gray-800' : 'bg-white'} z-10">${sanitizeHTML(s.code)}</td>
                                                <td class="px-4 py-3 font-medium sticky left-20 ${isDark ? 'bg-gray-800' : 'bg-white'} z-10">${sanitizeHTML(s.name)}</td>
                                                ${app.medicationTimes.map(time => {
                                                    const taken = app.medications[s.id]?.[time]?.taken || false;
                                                    return `
                                                        <td class="px-4 py-3 text-center">
                                                            <button onclick="updateMedication(${s.id}, '${time}', ${!taken});" class="${taken ? 'bg-purple-500 text-white shadow-lg scale-110' : isDark ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} w-10 h-10 rounded-lg transition-all transform hover:scale-105">
                                                                ${taken ? '‚úì' : ''}
                                                            </button>
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `}
                </div>
            `;
        };

        const renderHealthCheckPage = () => {
            const isDark = app.darkMode;
            const dormList = app.dormitories.filter(d => d !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
                        <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} text-sm">
                            ${formatThaiDate(app.selectedDate)}
                        </p>
                    </div>
                    
                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" value="${app.selectedDate}" onchange="app.selectedDate = this.value; loadHealthData();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full md:w-64 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" />
                    </div>

                    ${app.loadingData ? `
                        <div class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
                            <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-4">${app.loadingMessage}</p>
                        </div>
                    ` : dormList.map((dorm, index) => {
                        const dormStudents = app.students.filter(s => s.dorm === dorm);
                        const dormHealth = app.healthData[dorm] || {};
                        return `
                            <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6 border-l-4 border-green-500">
                                <div class="flex justify-between items-start mb-4 flex-wrap gap-4">
                                    <div>
                                        <h3 class="${isDark ? 'text-white' : 'text-gray-900'} font-bold text-lg">üèòÔ∏è ${dorm}</h3>
                                        <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} text-sm mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${dormStudents.length} ‡∏Ñ‡∏ô</p>
                                    </div>
                                    <button onclick="updateHealth('${dorm}', document.getElementById('health_textarea_${index}').value);" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium shadow-md hover:shadow-lg transition-all">
                                        ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                    </button>
                                </div>
                                <textarea 
                                    id="health_textarea_${index}"
                                    placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏ô‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏Ø‡∏•‡∏Ø"
                                    class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 bg-white placeholder-gray-400'} w-full px-4 py-3 border rounded-lg h-32 focus:ring-2 focus:ring-green-500 focus:outline-none resize-none"
                                >${dormHealth.notes || ''}</textarea>
                                <p class="${isDark ? 'text-gray-400' : 'text-gray-500'} text-xs mt-3 flex items-center gap-2">
                                    üïê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${dormHealth.timestamp ? new Date(dormHealth.timestamp).toLocaleString('th-TH', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    }) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                                </p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        const renderStatisticsPage = () => {
            const isDark = app.darkMode;
            const dailyStats = getDailyStats();
            const dormStats = getDormStats();
            const dormDailyStats = getDailyStatsByDorm();

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                        <button onclick="printReport();" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium shadow-md hover:shadow-lg transition-all">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </button>
                    </div>
                    
                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" value="${app.selectedDate}" onchange="app.selectedDate = this.value; loadAttendance();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full md:w-64 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                        <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-2 text-sm">${formatThaiDate(app.selectedDate)}</p>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6 border-t-4 border-purple-500">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-6 text-lg flex items-center gap-2">
                            üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${[
                                { key: 'morningReceived', label: '‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏£‡∏±‡∏ö', color: 'amber', icon: 'üì•' },
                                { key: 'morningSent', label: '‡πÄ‡∏ä‡πâ‡∏≤ - ‡∏™‡πà‡∏á', color: 'orange', icon: 'üì§' },
                                { key: 'eveningReceived', label: '‡πÄ‡∏¢‡πá‡∏ô - ‡∏£‡∏±‡∏ö', color: 'blue', icon: 'üì•' },
                                { key: 'eveningSent', label: '‡πÄ‡∏¢‡πá‡∏ô - ‡∏™‡πà‡∏á', color: 'cyan', icon: 'üì§' }
                            ].map(({ key, label, color, icon }) => {
                                const value = dailyStats[key];
                                const percent = dailyStats.total > 0 ? Math.round((value / dailyStats.total) * 100) : 0;
                                
                                return `
                                    <div class="bg-gradient-to-br from-${color}-500 to-${color}-600 rounded-xl p-6 text-white shadow-lg transform hover:scale-105 transition-transform">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <p class="text-${color}-100 text-sm">${label}</p>
                                                <p class="text-4xl font-bold mt-2">${value}</p>
                                                <div class="mt-2 flex items-center gap-2">
                                                    <div class="w-full bg-${color}-400 rounded-full h-2">
                                                        <div class="bg-white rounded-full h-2 transition-all" style="width: ${percent}%"></div>
                                                    </div>
                                                    <span class="text-${color}-200 text-sm whitespace-nowrap">${percent}%</span>
                                                </div>
                                            </div>
                                            <div class="text-6xl opacity-20">${icon}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-6 text-lg flex items-center gap-2">
                            üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏≠‡∏ô‡∏≠‡∏ô
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${Object.entries(dormStats).map(([dorm, count]) => {
                                const maxCount = Math.max(...Object.values(dormStats));
                                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                                return `
                                    <div class="${isDark ? 'bg-gray-700' : 'bg-gradient-to-r from-blue-50 to-blue-100'} rounded-lg p-4 border-l-4 border-blue-500 transform hover:scale-105 transition-transform">
                                        <p class="${isDark ? 'text-gray-300' : 'text-gray-600'} text-sm mb-2">${dorm}</p>
                                        <p class="${isDark ? 'text-white' : 'text-gray-900'} text-3xl font-bold">${count} ‡∏Ñ‡∏ô</p>
                                        <div class="mt-3 w-full bg-blue-200 rounded-full h-2">
                                            <div class="bg-blue-600 rounded-full h-2 transition-all duration-500" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6 border-t-4 border-green-500">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-6 text-lg flex items-center gap-2">
                            üèòÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô <span class="text-sm font-normal">(${formatThaiDate(app.selectedDate)})</span>
                        </h3>
                        <div class="space-y-4">
                            ${Object.entries(dormDailyStats).map(([dorm, stats]) => `
                                <div class="${isDark ? 'bg-gray-700' : 'bg-gradient-to-r from-green-50 to-green-100'} rounded-lg p-5 border-l-4 border-green-500">
                                    <p class="${isDark ? 'text-white' : 'text-gray-900'} font-bold mb-4 text-lg">${dorm} (‡∏£‡∏ß‡∏° ${stats.total} ‡∏Ñ‡∏ô)</p>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                        ${[
                                            { label: '‚úì ‡∏°‡∏≤', value: stats.present, color: 'green' },
                                            { label: '‚úì ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô', value: stats.returned, color: 'blue' },
                                            { label: '‚úì ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏≠', value: stats.leftInDorm, color: 'yellow' },
                                            { label: '‚úï ‡πÑ‡∏°‡πà‡∏°‡∏≤', value: stats.absent, color: 'red' }
                                        ].map(item => {
                                            const percent = stats.total > 0 ? Math.round((item.value/stats.total)*100) : 0;
                                            return `
                                                <div class="${isDark ? `bg-${item.color}-600` : `bg-${item.color}-200`} rounded-lg p-4 text-center">
                                                    <p class="${isDark ? `text-${item.color}-100` : `text-${item.color}-700`} text-xs mb-2">${item.label}</p>
                                                    <p class="${isDark ? 'text-white' : `text-${item.color}-900`} text-2xl font-bold">${item.value}</p>
                                                    <p class="${isDark ? `text-${item.color}-200` : `text-${item.color}-600`} text-xs mt-1">${percent}%</p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderStudentManagementPage = () => {
            const isDark = app.darkMode;
            const filteredStudents = app.students.filter(student => {
                const searchLower = app.searchTerm.toLowerCase();
                const matchesSearch = student.name.toLowerCase().includes(searchLower) ||
                                     student.nickname.toLowerCase().includes(searchLower) ||
                                     student.code.includes(app.searchTerm);
                return matchesSearch;
            });
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center flex-wrap gap-4">
                        <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <div class="flex gap-2">
                            <button onclick="importStudentsCSV();" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-md hover:shadow-lg transition-all">
                                üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                            </button>
                            <button onclick="exportAllStudents();" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 shadow-md hover:shadow-lg transition-all">
                                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6 border-t-4 border-green-500">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4 flex items-center gap-2">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                                <input type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1825" value="${app.newStudent.code}" oninput="app.newStudent.code = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                                <input type="text" placeholder="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á..." value="${app.newStudent.name}" oninput="app.newStudent.name = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" value="${app.newStudent.nickname}" oninput="app.newStudent.nickname = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏´‡∏≠‡∏ô‡∏≠‡∏ô *</label>
                                <select onchange="app.newStudent.dorm = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">
                                    ${app.dormitories.filter(d => d !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î').map(d => `<option ${app.newStudent.dorm === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</label>
                                <input type="text" placeholder="‡∏´‡πâ‡∏≠‡∏á 101" value="${app.newStudent.room}" oninput="app.newStudent.room = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                <input type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" value="${app.newStudent.disability}" oninput="app.newStudent.disability = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" />
                            </div>
                        </div>
                        <button onclick="addStudent();" class="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium shadow-md hover:shadow-lg transition-all">
                            ‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold flex items-center gap-2">
                                üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 
                                <span class="${isDark ? 'bg-blue-600' : 'bg-blue-100 text-blue-800'} px-3 py-1 rounded-full text-sm">
                                    ${app.students.length} ‡∏Ñ‡∏ô
                                </span>
                            </h3>
                            <div class="relative">
                                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${app.searchTerm}" oninput="handleSearch(this.value);" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'} px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none w-64" />
                                ${app.searchTerm ? `
                                    <button onclick="app.searchTerm = ''; render();" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 font-bold">
                                        ‚úï
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${app.loadingData ? `
                            <div class="text-center py-12">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                                <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-4">${app.loadingMessage}</p>
                            </div>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="${isDark ? 'bg-gray-700' : 'bg-blue-100'} border-b-2">
                                            <th class="px-4 py-3 text-left font-semibold">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                            <th class="px-4 py-3 text-left font-semibold">‡∏£‡∏´‡∏±‡∏™</th>
                                            <th class="px-4 py-3 text-left font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                            <th class="px-4 py-3 text-left font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                                            <th class="px-4 py-3 text-left font-semibold">‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</th>
                                            <th class="px-4 py-3 text-left font-semibold">‡∏´‡πâ‡∏≠‡∏á</th>
                                            <th class="px-4 py-3 text-left font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£</th>
                                            <th class="px-4 py-3 text-center font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                    <tbody class="${isDark ? 'divide-gray-700' : 'divide-gray-200'} divide-y">
                                        ${filteredStudents.length === 0 ? `
                                            <tr>
                                                <td colspan="8" class="px-4 py-8 text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                    ${app.searchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'}
                                                </td>
                                            </tr>
                                        ` : filteredStudents.map((s, index) => `
                                            <tr class="${isDark ? 'hover:bg-gray-700' : 'hover:bg-blue-50'} transition-colors">
                                                <td class="px-4 py-3 text-center">${index + 1}</td>
                                                <td class="px-4 py-3 font-mono">${sanitizeHTML(s.code)}</td>
                                                <td class="px-4 py-3 font-medium">${sanitizeHTML(s.name)}</td>
                                                <td class="px-4 py-3">${sanitizeHTML(s.nickname)}</td>
                                                <td class="px-4 py-3">${sanitizeHTML(s.dorm)}</td>
                                                <td class="px-4 py-3">${sanitizeHTML(s.room)}</td>
                                                <td class="px-4 py-3">${sanitizeHTML(s.disability) || '-'}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <div class="flex gap-2 justify-center">
                                                        <button onclick="editStudent(${s.id});" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium transition-colors">
                                                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                                        </button>
                                                        <button onclick="deleteStudent(${s.id});" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs font-medium transition-colors">
                                                            üóëÔ∏è ‡∏•‡∏ö
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>

                    ${app.editingStudent ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                            <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-2xl p-6 w-full max-w-2xl">
                                <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4 text-xl">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                                        <input type="text" value="${app.editForm.code}" oninput="app.editForm.code = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                                        <input type="text" value="${app.editForm.name}" oninput="app.editForm.name = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                        <input type="text" value="${app.editForm.nickname}" oninput="app.editForm.nickname = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏´‡∏≠‡∏ô‡∏≠‡∏ô *</label>
                                        <select onchange="app.editForm.dorm = this.value; render();" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                            ${app.dormitories.filter(d => d !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î').map(d => `<option ${app.editForm.dorm === d ? 'selected' : ''}>${d}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</label>
                                        <input type="text" value="${app.editForm.room}" oninput="app.editForm.room = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£</label>
                                        <input type="text" value="${app.editForm.disability}" oninput="app.editForm.disability = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button onclick="saveEditStudent();" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors">
                                        ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                    </button>
                                    <button onclick="cancelEdit();" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium transition-colors">
                                        ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        const renderSettingsPage = () => {
            const isDark = app.darkMode;
            const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
            
            return `
                <div class="space-y-6">
                    <h2 class="${isDark ? 'text-white' : 'text-gray-800'} text-xl font-bold">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6 border-t-4 border-blue-500">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4 flex items-center gap-2">
                            üè´ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" value="${app.systemSettings.schoolName}" oninput="app.systemSettings.schoolName = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</label>
                                <input type="text" value="${app.systemSettings.dormName}" oninput="app.systemSettings.dormName = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                                <input type="text" value="${app.systemSettings.academicYear}" oninput="app.systemSettings.academicYear = this.value;" class="${isDark ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'} w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            </div>
                            <button onclick="saveSystemSettings();" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md hover:shadow-lg transition-all">
                                ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                            </button>
                        </div>
                    </div>

                    <div class="${isDark ? 'bg-gray-700' : 'bg-gradient-to-r from-blue-50 to-blue-100'} rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4 flex items-center gap-2">
                            üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center gap-3">
                                <span class="${isDark ? 'text-gray-400' : 'text-gray-600'}">‡∏ä‡∏∑‡πà‡∏≠:</span>
                                <span class="${isDark ? 'text-white' : 'text-gray-900'} font-medium">${app.currentUser?.name}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="${isDark ? 'text-gray-400' : 'text-gray-600'}">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
                                <span class="${isDark ? 'text-white' : 'text-gray-900'} font-medium">${app.currentUser?.username}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="${isDark ? 'text-gray-400' : 'text-gray-600'}">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</span>
                                <span class="${isDark ? 'bg-blue-600' : 'bg-blue-500'} text-white px-3 py-1 rounded-full text-xs font-medium">
                                    ${app.currentUser?.role === 'admin' ? 'üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö' : 'üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏≠'}
                                </span>
                            </div>
                        </div>
                    </div>

                    ${!isOnline || pendingChanges.length > 0 ? `
                        <div class="${isDark ? 'bg-yellow-900' : 'bg-yellow-50'} border ${isDark ? 'border-yellow-700' : 'border-yellow-200'} rounded-xl p-6">
                            <h3 class="${isDark ? 'text-yellow-200' : 'text-yellow-800'} font-bold mb-3 flex items-center gap-2">
                                ${!isOnline ? '‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå' : 'üìå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå'}
                            </h3>
                            <div class="space-y-2 text-sm ${isDark ? 'text-yellow-300' : 'text-yellow-700'}">
                                ${!isOnline ? '<p>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</p>' : ''}
                                ${pendingChanges.length > 0 ? `
                                    <p>üìå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${pendingChanges.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</p>
                                    <button onclick="syncPendingChanges();" class="mt-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-medium">
                                        üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="${isDark ? 'bg-green-900' : 'bg-green-50'} border ${isDark ? 'border-green-700' : 'border-green-200'} rounded-xl p-6">
                        <h3 class="${isDark ? 'text-green-200' : 'text-green-800'} font-bold mb-3 flex items-center gap-2">
                            ${isOnline ? '‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : 'üíæ'} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase
                        </h3>
                        <div class="space-y-2 text-sm ${isDark ? 'text-green-300' : 'text-green-700'}">
                            <p>${isOnline ? '‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'üíæ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'}</p>
                            <p class="text-xs">Project: ${firebaseConfig.projectId}</p>
                            <p class="text-xs mt-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Cloud Database ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p class="text-xs">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    </div>

                    <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-md p-6">
                        <h3 class="${isDark ? 'text-white' : 'text-gray-800'} font-bold mb-4 flex items-center gap-2">
                            ‚ÑπÔ∏è ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
                        </h3>
                        <div class="space-y-2 text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}">
                            <p>üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏ô‡∏≠‡∏ô (Dormitory Management System)</p>
                            <p>üèóÔ∏è ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 3.0 - Complete Edition</p>
                            <p>üöÄ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥:</p>
                            <ul class="list-disc list-inside ml-4 space-y-1">
                                <li>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</li>
                                <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</li>
                                <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</li>
                                <li>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</li>
                                <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</li>
                                <li>‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                                <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                <li>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Dark Mode</li>
                                <li>Responsive Design</li>
                            </ul>
                            <p class="mt-4">üíæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏ö‡∏ô Cloud Firestore</p>
                            <p>üé® ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï</p>
                            <p>üîí ‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        </div>
                    </div>
                </div>
            `;
        };

        // ================== Main Render Function ==================

        const render = () => {
            const isDark = app.darkMode;
            const root = document.getElementById('app');
            
            if (!app.isLoggedIn) {
                root.innerHTML = `
                    <div class="${isDark ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-600 to-blue-800'} min-h-screen flex items-center justify-center p-4">
                        <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full flex items-center justify-center text-white text-4xl font-bold mx-auto mb-4 shadow-lg">
                                    üè†
                                </div>
                                <h1 class="${isDark ? 'text-white' : 'text-gray-800'} text-3xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</h1>
                                <p class="${isDark ? 'text-gray-400' : 'text-gray-600'} mt-2">${app.systemSettings.schoolName}</p>
                                <div class="mt-2 flex items-center justify-center gap-2">
                                    ${isOnline ? 
                                        `<span class="inline-flex items-center gap-1 text-green-600 text-xs">
                                            <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                                            ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                                        </span>` 
                                        : 
                                        `<span class="inline-flex items-center gap-1 text-yellow-600 text-xs">
                                            <span class="w-2 h-2 bg-yellow-600 rounded-full"></span>
                                            ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
                                        </span>`
                                    }
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                                    <input type="text" placeholder="admin ‡∏´‡∏£‡∏∑‡∏≠ teacher" value="${app.loginForm.username}" oninput="app.loginForm.username = this.value;" onkeypress="if(event.key==='Enter') handleLogin();" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all" autofocus />
                                </div>
                                <div>
                                    <label class="${isDark ? 'text-gray-300' : 'text-gray-700'} block text-sm font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                    <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="${app.loginForm.password}" oninput="app.loginForm.password = this.value;" onkeypress="if(event.key==='Enter') handleLogin();" class="${isDark ? 'bg-gray-700 text-white border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'} w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all" />
                                </div>
                                ${app.loginError ? `<div class="p-3 ${isDark ? 'bg-red-900 text-red-300' : 'bg-red-100 text-red-700'} border border-red-400 rounded-lg text-sm animate-shake">${app.loginError}</div>` : ''}
                                <button onclick="handleLogin();" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 font-bold transition-all shadow-md hover:shadow-lg">
                                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                                </button>
                            </div>
                            <div class="${isDark ? 'bg-gray-700 text-gray-300' : 'bg-blue-50 text-gray-700'} mt-6 p-4 rounded-lg text-sm">
                                <p class="font-bold mb-2">üîê ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</p>
                                <p class="mb-1">üë§ Admin: <code class="${isDark ? 'bg-gray-800' : 'bg-white'} px-2 py-1 rounded text-green-600">admin / admin123</code></p>
                                <p>üë®‚Äçüè´ Teacher: <code class="${isDark ? 'bg-gray-800' : 'bg-white'} px-2 py-1 rounded text-green-600">teacher / teacher123</code></p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            const pages = {
                attendance: renderAttendancePage(),
                medication: renderMedicationPage(),
                health: renderHealthCheckPage(),
                statistics: renderStatisticsPage(),
                students: renderStudentManagementPage(),
                settings: renderSettingsPage()
            };

            root.innerHTML = `
                <div class="flex h-screen ${isDark ? 'bg-gray-900' : 'bg-gray-100'}">
                    <!-- Sidebar -->
                    <div class="${app.sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 fixed inset-y-0 left-0 z-50 w-64 bg-gradient-to-b from-blue-600 to-blue-800 text-white transform transition-transform duration-300 shadow-2xl">
                        <div class="p-6 border-b border-blue-700">
                            <h2 class="text-xl font-bold">${app.systemSettings.dormName}</h2>
                            <p class="text-xs text-blue-200 mt-1">${app.systemSettings.schoolName}</p>
                            <div class="mt-2 flex items-center gap-2">
                                ${isOnline ? 
                                    '<span class="inline-flex items-center gap-1 text-green-300 text-xs"><span class="w-2 h-2 bg-green-300 rounded-full animate-pulse"></span>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>' 
                                    : 
                                    '<span class="inline-flex items-center gap-1 text-yellow-300 text-xs"><span class="w-2 h-2 bg-yellow-300 rounded-full"></span>‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</span>'
                                }
                            </div>
                            <button onclick="app.sidebarOpen = false; render();" class="lg:hidden absolute top-6 right-6 hover:bg-blue-700 rounded p-1 transition-colors">‚úï</button>
                        </div>
                        <nav class="mt-6 px-3 space-y-2 overflow-y-auto" style="max-height: calc(100vh - 250px);">
                            ${[
                                { page: 'attendance', label:
                                    '‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠' },
                                { page: 'medication', label: 'üíä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤' },
                                { page: 'health', label: 'üå°Ô∏è ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                                { page: 'statistics', label: 'üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥' },
                                { page: 'students', label: 'üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
                                { page: 'settings', label: '‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' }
                            ].map(({ page, label }) => `
                                <button onclick="app.currentPage = '${page}'; app.sidebarOpen = false; render();" class="w-full text-left px-4 py-3 rounded-lg transition-all font-medium ${app.currentPage === page ? 'bg-blue-700 shadow-lg scale-105' : 'text-blue-100 hover:bg-blue-700/50 hover:scale-102'}">
                                    ${label}
                                </button>
                            `).join('')}
                        </nav>
                        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-blue-700 space-y-2">
                            <button onclick="app.darkMode = !app.darkMode; document.documentElement.classList.toggle('dark', app.darkMode); render();" class="w-full flex items-center space-x-3 px-4 py-3 text-blue-100 hover:bg-blue-700/50 rounded-lg transition-colors">
                                <span class="text-xl">${app.darkMode ? '‚òÄÔ∏è' : 'üåô'}</span> 
                                <span>${app.darkMode ? 'Light Mode' : 'Dark Mode'}</span>
                            </button>
                            <button onclick="handleLogout();" class="w-full flex items-center space-x-3 px-4 py-3 text-blue-100 hover:bg-blue-700/50 rounded-lg transition-colors">
                                <span class="text-xl">üö™</span> 
                                <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 lg:ml-64 flex flex-col">
                        <!-- Header -->
                        <div class="${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white'} shadow-md border-b">
                            <div class="flex items-center justify-between px-6 py-4">
                                <button onclick="app.sidebarOpen = true; render();" class="lg:hidden ${isDark ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'} text-2xl transition-colors">‚ò∞</button>
                                <h1 class="${isDark ? 'text-white' : 'text-gray-800'} text-2xl font-bold hidden lg:block">${app.systemSettings.dormName}</h1>
                                <div class="text-right">
                                    <p class="${isDark ? 'text-white' : 'text-gray-900'} text-sm font-medium">${app.currentUser?.name}</p>
                                    <p class="${isDark ? 'text-gray-400' : 'text-gray-500'} text-xs">${app.currentUser?.role === 'admin' ? 'üë®‚Äçüíº Admin' : 'üë®‚Äçüè´ Teacher'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Page Content -->
                        <div class="${isDark ? 'bg-gray-900' : 'bg-gray-100'} flex-1 overflow-auto p-6">
                            ${pages[app.currentPage]}
                        </div>
                    </div>

                    <!-- Toast Notification -->
                    ${app.toastMessage ? `
                        <div class="${app.toastType === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-6 py-4 rounded-lg shadow-2xl fixed top-4 right-4 z-50 flex items-center gap-3 animate-slide-in max-w-md">
                            <span class="text-2xl">${app.toastType === 'success' ? '‚úì' : '‚úï'}</span>
                            <span class="font-medium whitespace-pre-line">${app.toastMessage}</span>
                        </div>
                    ` : ''}

                    <!-- Sidebar Overlay -->
                    ${app.sidebarOpen ? `<div onclick="app.sidebarOpen = false; render();" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden backdrop-blur-sm"></div>` : ''}
                </div>

                <style>
                    @keyframes slide-in {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                        20%, 40%, 60%, 80% { transform: translateX(5px); }
                    }
                    .animate-slide-in {
                        animation: slide-in 0.3s ease-out;
                    }
                    .animate-shake {
                        animation: shake 0.5s ease-in-out;
                    }
                    
                    /* Custom Scrollbar */
                    ::-webkit-scrollbar {
                        width: 8px;
                        height: 8px;
                    }
                    ::-webkit-scrollbar-track {
                        background: ${isDark ? '#1f2937' : '#f1f1f1'};
                    }
                    ::-webkit-scrollbar-thumb {
                        background: ${isDark ? '#4b5563' : '#888'};
                        border-radius: 4px;
                    }
                    ::-webkit-scrollbar-thumb:hover {
                        background: ${isDark ? '#6b7280' : '#555'};
                    }

                    /* Print Styles */
                    @media print {
                        body { margin: 0; padding: 0; }
                        .no-print { display: none !important; }
                    }

                    /* Loading Animation */
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                    .animate-spin {
                        animation: spin 1s linear infinite;
                    }

                    /* Pulse Animation */
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                    .animate-pulse {
                        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                    }
                </style>
            `;
        };

        // ================== Global Error Handlers ==================

        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (app.isLoggedIn) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            if (app.isLoggedIn) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•', 'error');
            }
        });

        // ================== Keyboard Shortcuts ==================

        document.addEventListener('keydown', (e) => {
            if (!app.isLoggedIn) return;

            // ESC key
            if (e.key === 'Escape') {
                if (app.sidebarOpen) {
                    app.sidebarOpen = false;
                    render();
                }
                if (app.editingStudent) {
                    app.editingStudent = null;
                    render();
                }
            }
            
            // Ctrl/Cmd + S to save (prevent default)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'success');
            }

            // Ctrl/Cmd + P to print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p' && app.currentPage === 'attendance') {
                e.preventDefault();
                printReport();
            }

            // Ctrl/Cmd + K for search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.querySelector('input[placeholder*="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"]');
                if (searchInput) searchInput.focus();
            }
        });

        // ================== Initialize App ==================

        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            app.darkMode = true;
            document.documentElement.classList.add('dark');
        }

        // Check for existing session
        checkSession();

        // Initial render
        render();

        // Log system info
        console.log('%cüè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏ô‡∏≠‡∏ô v3.0 - Complete Edition', 'color: #2563eb; font-size: 20px; font-weight: bold;');
        console.log('%c‚úÖ System Ready', 'color: #16a34a; font-size: 14px;');
        console.log('%cüìä Firebase: ' + (isOnline ? 'Connected' : 'Offline Mode'), 'color: ' + (isOnline ? '#16a34a' : '#ca8a04') + '; font-size: 12px;');
        console.log('%cüé® UI: Loaded', 'color: #16a34a; font-size: 12px;');
        console.log('%cüíæ Offline Support: Enabled', 'color: #16a34a; font-size: 12px;');
        console.log('%cüîí Input Validation: Active', 'color: #16a34a; font-size: 12px;');
        
        // Display feature list
        console.groupCollapsed('%cüìã Available Features', 'color: #2563eb; font-weight: bold;');
        console.log('‚úì Real-time attendance tracking');
        console.log('‚úì Medication logging');
        console.log('‚úì Health records');
        console.log('‚úì Statistics & Reports');
        console.log('‚úì Student management');
        console.log('‚úì CSV Import/Export');
        console.log('‚úì Offline support with auto-sync');
        console.log('‚úì Input validation & sanitization');
        console.log('‚úì Dark mode support');
        console.log('‚úì Responsive design');
        console.log('‚úì Print functionality');
        console.log('‚úì Keyboard shortcuts');
        console.groupEnd();

        // Display keyboard shortcuts
        console.groupCollapsed('%c‚å®Ô∏è Keyboard Shortcuts', 'color: #2563eb; font-weight: bold;');
        console.log('ESC - Close modals/sidebar');
        console.log('Ctrl/Cmd + S - Save notification');
        console.log('Ctrl/Cmd + P - Print report (on attendance page)');
        console.log('Ctrl/Cmd + K - Focus search');
        console.groupEnd();

        // Performance monitoring
        if (performance && performance.now) {
            const loadTime = performance.now();
            console.log(`%c‚ö° Load Time: ${Math.round(loadTime)}ms`, 'color: #16a34a; font-size: 12px;');
        }

        // Service Worker Registration (optional - for PWA support)
        if ('serviceWorker' in navigator) {
            console.log('%cüì± Service Worker: Available (can be enabled for PWA)', 'color: #2563eb; font-size: 12px;');
        }

        // Storage info
        if (navigator.storage && navigator.storage.estimate) {
            navigator.storage.estimate().then(estimate => {
                const used = (estimate.usage / (1024 * 1024)).toFixed(2);
                const quota = (estimate.quota / (1024 * 1024)).toFixed(2);
                console.log(`%cüíæ Storage: ${used}MB / ${quota}MB`, 'color: #2563eb; font-size: 12px;');
            });
        }

        // Version check
        const version = '3.0.0';
        const buildDate = new Date().toISOString().split('T')[0];
        console.log(`%cüîñ Version: ${version} (${buildDate})`, 'color: #6b7280; font-size: 11px;');
        
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #2563eb;');
    </script>
</body>
</html>
